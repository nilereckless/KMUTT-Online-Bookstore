<!DOCTYPE html>
<html lang="en">

<head>
    <title>KMUTT Bookstore management</title>
</head>
<% include ../layouts/header.ejs %>

    <body class="container" style="margin-top: 50px;">
        <h1 class="text-center">Admin Organization</h1> <br>
        <% if(messages.error) { %>
            <div class="alert alert-danger" role="alert">
                <%= messages.error %>
            </div>
            <% } %>
                <div class="back">
                    <a href="/books" class="btn btn-info">Back</a>
                </div>
                <br>
                <div class="card">
                    <div class="card-header">
                        Add Book
                        <div style="float: right;">
                            <input id="input" type="text">
                            <button onclick="getBooks();">ISBN</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form action="/books/add" method="post" enctype="multipart/form-data">
                            <div class="form-group">
                                <label>BookName:</label>
                                <input type="text" class="form-control" name="name" value="<%= name %> "
                                    autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>Author:</label>
                                <input type="text" class="form-control" name="author" id="author" value="<%= author %> "
                                    autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>Price:</label>
                                <input type="number" class="form-control" name="price" min="50" value="<%= price %> "
                                    autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>Stock:</label>
                                <input type="number" class="form-control" name="stock" value="<%= stock %> "
                                    autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>Isbn:</label>
                                <input type="number" class="form-control" name="isbn" value="<%= isbn %> "
                                    autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label>Select your profile picture:</label>
                                <input type="file" name="book_pic" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Catagory:</label>
                                <select name="catagory" id="catagory">
                                    <option value="Education">Education</option>
                                    <option value="Information Technology">Information Technology</option>
                                    <option value="Fantasy">Fantasy</option>
                                    <option value="Other...">Other...</option>
                                </select>
                                <!--<input type="text" class="form-control" name="catagory" value="<%= catagory %> " autocomplete="off"> -->
                            </div>
                            <div class="form-group">
                                <input type="submit" class="btn btn-success" value="Add">
                            </div>
                        </form>
                    </div>
                </div>


    </body>
    <% include ../layouts/footer.ejs %>
        <script>

            function getBooks() {
                fetch("https://openlibrary.org/search.json?q=" + document.getElementById("input").value)
                    .then(a => a.json())
                    .then(response => {
                        if (response.numFound !== 0) {
                            for (var i = 0; i < response.docs.length; i++) {
                                getBookInfo(response.docs[i].title, response.docs[i].author_name[0], response.docs[i].first_publish_year, response.docs[i].isbn[0]);
                            }
                        } else {
                            alert("ISBN is invalid or not found.");
                        }
                    }
                    );

                function getBookInfo(bookName, author, year, imageUrl) {
                    var isbn = imageUrl;
                    var savedImgUrl = `http://covers.openlibrary.org/b/isbn/${imageUrl}-M.jpg`;
                    Swal.mixin({
                        confirmButtonText: 'Next &rarr;',
                        showCancelButton: true,
                        progressSteps: ['1', '2', '3']
                    }).queue([
                        {
                            title: bookName,
                            html: `${author} (${year}) <br> <img src='http://covers.openlibrary.org/b/isbn/${imageUrl}-M.jpg'>`
                        },
                        {
                            title: 'Books own',
                            html: `
                   <label for="catalogue">Category:</label>
                   <select name="category" id="category" required>
                   <option value="Fantasy">Fantasy</option>
                   <option value="Education">Education</option>
                   <option value="Information Technology">Information Technology</option>
                   <option value="Other...">Other</option>
                   </select>
                   <div>
                   <label>Stock:</label>
                   <input type="number" placeholder="Please fill number stock" min="1" value="1" id="input_stock" required> <br>
                   <label>Price:</label>
                   <input type="number" placeholder="price" value="1" min="50" id="price" required>
                   </div>
                   `,
                            preConfirm: function () {
                                return new Promise((resolve, reject) => {
                                    resolve({
                                        catagory: $('#category').val(),
                                        stock: $('#input_stock').val(),
                                        price: $('#price').val(),
                                    });
                                });
                            }
                        }
                    ]).then((result) => {
                        console.log(result);
                        if (result.value) {

                            addBook(bookName, author, result.value[1].catagory, savedImgUrl, result.value[1].stock, result.value[1].price, isbn);
                        } else {

                            Swal.fire({
                                title: 'Confirm cancel?',
                                text: "You can insert another new book",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#3085d6',
                                cancelButtonColor: '#d33',
                                confirmButtonText: 'Yes, confirm'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    Swal.fire(
                                        'Cancel',
                                        '',
                                        'success'
                                    )
                                } else {

                                }
                            })


                        }
                    })
                }
                function addBook(name, author, category, imageUrl, stock, price, isbn) {
                    var settings = {
                        "url": "http://localhost:3000/books/add",
                        "method": "POST",
                        "timeout": 0,
                        "headers": {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        "data": {
                            "name": name,
                            "author": author,
                            "price": price,
                            "catagory": category,
                            "imageUrl": imageUrl,
                            "stock": stock,
                            "isbn": isbn
                        }
                    };

                    $.ajax(settings)
                        .done(function (response) {
                            if (response.status !== undefined && response.status === "errors") {
                                alert(response.message);
                            } else {
                                Swal.fire(
                                    'Done',
                                    'Add book success.', 'success');
                            }

                        });


                }



            }
            var authorList = [];
            function fetchBookauthorData() {
                $.ajax({
                    type: "POST",
                    url: "/books/author/suggest",
                    success: function (response) {
                        for (var i = 0; i < response.length; i++) {
                            authorList.push(response[i]);
                        }
                        console.log(response);
                    },
                    error: function (jqXhr, textStatus, errorThrown) {
                        alert(errorThrown);
                    }
                }
                );
            }

            $("#author").autocomplete({
                source: authorList
            });
            $(document).ready(function () {
                fetchBookauthorData();
                console.log("Phrase 1");
            });


        </script>


</html>